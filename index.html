<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Trending Analyzer - Dashboard</title>
    
    <link rel="icon" href="https://www.youtube.com/s/desktop/1a56be5e/img/favicon.ico" type="image/x-icon">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Light Theme - YouTube Red Theme */
            --bg: #f8f9fa;
            --text: #212529;
            --heading: #212529;
            --accent: #FF0000; /* YouTube Red */
            --accent-light: #ff4d4d;
            --accent-dark: #cc0000;
            --card-bg: #ffffff;
            --surface: #f1f3f5;
            --btn-text: #ffffff;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #FF0000 0%, #cc0000 100%); /* YouTube Red Gradient */
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --sidebar-bg: #ffffff;
            --main-bg: #f8f9fa;
            --border-color: #e9ecef;
            /* Chart color palette - YouTube Red theme */
            --chart1: #FF0000;
            --chart2: #ff4d4d;
            --chart3: #ff8080;
            --chart4: #7c3aed;
            --chart5: #a78bfa;
            --chart6: #06b6d4;
            --chart7: #67e8f9;
            --chart8: #fbbf24;
            --chart9: #34d399;
            --chart10: #60a5fa;
            --barFill: #FF0000;
            --barBorder: #FF0000;
            --barHover: #ff4d4d;
            --engFill: rgba(255, 0, 0, 0.7);
            --engBorder: #FF0000;
            --engHover: #FF0000;
            /* Custom scrollbar colors */
            --scrollbar-bg: #f1f1f1;
            --scrollbar-thumb: #cccccc;
            --scrollbar-thumb-hover: #999999;
        }

        [data-theme="dark"] {
            /* Dark Theme - YouTube Red Theme */
            --bg: #0f0f0f;
            --text: #e5e7eb;
            --heading: #f3f4f6;
            --accent: #FF0000; /* YouTube Red */
            --accent-light: #ff4d4d;
            --accent-dark: #cc0000;
            --card-bg: #1a1a1a;
            --surface: #232323;
            --btn-text: #ffffff;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #FF0000 0%, #cc0000 100%); /* YouTube Red Gradient */
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s ease;
            --sidebar-bg: #1a1a1a;
            --main-bg: #0f0f0f;
            --border-color: #333333;
            /* Chart color palette - YouTube Red theme */
            --chart1: #FF0000;
            --chart2: #ff4d4d;
            --chart3: #ff8080;
            --chart4: #a78bfa;
            --chart5: #c4b5fd;
            --chart6: #22d3ee;
            --chart7: #67e8f9;
            --chart8: #fbbf24;
            --chart9: #34d399;
            --chart10: #60a5fa;
            --barFill: #FF0000;
            --barBorder: #FF0000;
            --barHover: #ff4d4d;
            --engFill: rgba(255, 0, 0, 0.7);
            --engBorder: #FF0000;
            --engHover: #FF0000;
            /* Custom scrollbar colors - Dark theme */
            --scrollbar-bg: #2a2a2a;
            --scrollbar-thumb: #555555;
            --scrollbar-thumb-hover: #777777;
        }

        /* Basic Reset & Typography */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background-color .3s ease, color .3s ease;
            overflow-x: hidden;
        }

        /* Custom Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-bg);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 10px;
            transition: background-color 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        /* Firefox scrollbar styling */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-bg);
        }

        /* Header */
        header {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.1) 0%, rgba(204, 0, 0, 0.1) 100%);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid var(--border-color);
        }

        .header-content {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo i {
            font-size: 2rem;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 0;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle,
        .header-btn {
            padding: 0.5rem 1rem;
            background: var(--gradient-2);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
            font-size: 0.9rem;
        }

        .theme-toggle:hover,
        .header-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.4);
        }
        
        .header-btn {
            background: var(--gradient-1); /* Use a different gradient */
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .header-btn:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }


        /* Split Layout Container */
        .split-container {
            display: flex;
            height: calc(100vh - 80px);
            position: relative;
        }

        /* Sidebar (Left Panel) */
        .sidebar {
            width: 40%;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 20px;
            transition: background-color .3s ease;
        }

        /* Main Content (Right Panel) */
        .main-content {
            width: 60%;
            background-color: var(--main-bg);
            overflow-y: auto;
            padding: 20px;
            transition: background-color .3s ease;
        }

        /* Controls Area */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background-color: var(--surface);
            border-radius: 16px;
            box-shadow: var(--shadow);
            transition: background-color .3s ease;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .controls label {
            font-size: 1em;
            font-weight: 500;
            color: var(--text);
            transition: color .3s ease;
            min-width: 120px;
        }

        .controls select {
            padding: 10px 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text);
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition);
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-6.5%200-12.3%203.2-16.1%208.1-3.8%204.9-4.7%2011-2.7%2017.2l128%20160c3.7%204.7%209.1%207.5%2014.7%207.5s11-2.8%2014.7-7.5l128-160c2.1-6.2%201.2-12.3-2.7-17.2z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px auto;
            padding-right: 35px;
            flex: 1;
        }

        [data-theme="dark"] .controls select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e5e7eb%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-6.5%200-12.3%203.2-16.1%208.1-3.8%204.9-4.7%2011-2.7%2017.2l128%20160c3.7%204.7%209.1%207.5%2014.7%207.5s11-2.8%2014.7-7.5l128-160c2.1-6.2%201.2-12.3-2.7-17.2z%22/%3E%3C/svg%3E');
        }

        .controls select:hover {
            border-color: var(--accent);
        }
        
        .controls select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.25);
            outline: none;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
            text-align: center;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text);
            opacity: 0.7;
        }

        /* Data Insights Section */
        .data-insights {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--heading);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            background: var(--gradient-2);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid;
            flex-wrap: wrap;
        }

        :root .tab-bar {
            border-bottom-color: rgba(31, 41, 55, 0.1);
        }

        [data-theme="dark"] .tab-bar {
            border-bottom-color: rgba(229, 231, 235, 0.1);
        }

        .tab-btn {
            padding: 8px 16px;
            background-color: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Poppins', sans-serif;
            opacity: 0.7;
            position: relative;
            bottom: -2px;
        }

        .tab-btn:hover {
            opacity: 0.9;
            color: var(--accent);
        }

        .tab-btn.active {
            opacity: 1;
            color: var(--accent);
            border-bottom-color: var(--accent);
            font-weight: 600;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            transition: background-color .3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .chart-tab {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .chart-tab.active {
            display: block;
        }

        /* Upload Recommendations Styles */
        .upload-recommendations {
            margin-top: 20px;
            padding: 20px;
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .ml-recommendations {
            color: var(--text);
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .recommendation-header i {
            font-size: 1.5rem;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .recommendation-header h4 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--heading);
        }

        .recommendation-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .best-time-recommendation,
        .best-category-recommendation {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: 10px;
            border-left: 4px solid var(--accent);
            transition: var(--transition);
        }

        .best-time-recommendation:hover,
        .best-category-recommendation:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(255, 0, 0, 0.2);
        }

        .recommendation-icon {
            font-size: 2rem;
        }

        .recommendation-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recommendation-content strong {
            color: var(--heading);
            font-size: 0.95rem;
        }

        .best-time,
        .best-category {
            font-size: 1.3rem;
            font-weight: 700;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .best-time-stats {
            font-size: 0.85rem;
            color: var(--text);
            opacity: 0.7;
        }

        .top-hours {
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: 10px;
        }

        .top-hours strong {
            display: block;
            margin-bottom: 12px;
            color: var(--heading);
            font-size: 0.95rem;
        }

        .recommendation-hour {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            margin-bottom: 8px;
            background-color: var(--surface);
            border-radius: 8px;
            transition: var(--transition);
        }

        .recommendation-hour:hover {
            background-color: var(--accent);
            color: white;
            transform: translateX(5px);
        }

        .recommendation-hour:last-child {
            margin-bottom: 0;
        }

        .hour-rank {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--gradient-2);
            color: white;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .hour-time {
            flex: 1;
            font-weight: 600;
            font-size: 1rem;
        }

        .hour-views {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .recommendation-text {
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: 10px;
            border-left: 4px solid var(--accent);
        }

        .recommendation-text p {
            margin: 0;
            line-height: 1.6;
            color: var(--text);
            font-size: 0.95rem;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Video Section */
        .video-section {
            margin-bottom: 25px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .video-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .video-thumbnail {
            position: relative;
            height: 140px;
            overflow: hidden;
        }

        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition);
        }

        .video-card:hover .video-thumbnail img {
            transform: scale(1.05);
        }

        .video-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .video-info {
            padding: 12px;
        }

        .video-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            max-height: 2.6em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            transition: color .3s ease;
        }

        .video-meta {
            font-size: 0.8rem;
            color: var(--text);
            opacity: 0.7;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .video-meta-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .video-meta i {
            color: var(--accent);
        }

        .sentiment-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.3rem;
        }

        .sentiment-positive {
            background-color: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .sentiment-negative {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .sentiment-neutral {
            background-color: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }

        /* Expanded Video View */
        .expanded-video {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: background-color .3s ease;
            grid-column: 1 / -1; /* Span full width of grid */
            width: 100%;
        }

        .expanded-video-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .expanded-video-thumbnail {
            flex-shrink: 0;
            width: 300px;
            border-radius: 8px;
            overflow: hidden;
        }

        .expanded-video-thumbnail img {
            width: 100%;
            height: auto;
            display: block;
        }

        .expanded-video-info {
            flex: 1;
        }

        .expanded-video-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--heading);
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .expanded-video-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }

        .expanded-video-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text);
        }

        .expanded-video-stat i {
            color: var(--accent);
        }

        .expanded-video-description {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .expanded-video-description h5 {
            font-size: 1em;
            font-weight: 600;
            color: var(--heading);
            margin-bottom: 10px;
        }

        .expanded-video-description p {
            color: var(--text);
            opacity: 0.8;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Loader */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        /* AI Suggestion Modal Styles */
        .ai-loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
            display: none; /* Hidden by default */
        }

        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 10% auto;
            padding: 0;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 700px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.4s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--heading);
        }

        .modal-close {
            color: var(--text);
            opacity: 0.6;
            font-size: 2rem;
            font-weight: bold;
            transition: var(--transition);
        }

        .modal-close:hover,
        .modal-close:focus {
            color: var(--accent);
            text-decoration: none;
            cursor: pointer;
            transform: scale(1.1);
        }

        .modal-body {
            padding: 25px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .suggestion-error {
            background-color: var(--surface);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 20px;
            border-radius: 12px;
            font-weight: 500;
        }
        .suggestion-error strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .suggestion-item {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }

        .suggestion-item h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--heading);
            margin-top: 0;
            margin-bottom: 10px;
        }

        .suggestion-item p {
            font-size: 0.95rem;
            color: var(--text);
            margin: 5px 0;
            line-height: 1.6;
        }
        
        .suggestion-item p strong {
            color: var(--accent);
            font-weight: 600;
        }


        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text);
            opacity: 0.7;
            font-size: 0.8rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }

        .footer a {
            color: var(--accent);
            text-decoration: none;
            transition: color .3s ease;
        }

        .footer a:hover {
            text-decoration: underline;
            opacity: 0.8;
        }

        /* Mobile Toggle Button */
        .mobile-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--gradient-2);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 0, 0, 0.4);
            z-index: 1000;
            transition: var(--transition);
        }

        .mobile-toggle:hover {
            transform: scale(1.1);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .split-container {
                flex-direction: column;
                height: auto;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                max-height: 60vh;
            }

            .main-content {
                width: 100%;
                min-height: 40vh;
            }

            .mobile-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar.hidden {
                display: none;
            }

            .main-content.full-width {
                width: 100%;
            }
            
            .modal-content {
                margin: 5% auto;
                width: 95%;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 0.5rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .video-grid {
                grid-template-columns: 1fr;
            }

            .control-row {
                flex-direction: column;
                align-items: stretch;
            }

            .controls label {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <i class="fab fa-youtube"></i>
                <h1>YouTube Trending Analyzer</h1>
            </div>
            <div class="header-controls">
                <button id="aiSuggestBtn" class="header-btn">
                    <i class="fas fa-lightbulb"></i>
                    <span>Get AI Ideas</span>
                </button>
                <button id="themeToggle" class="theme-toggle">
                    <i class="fas fa-moon"></i>
                    <span>Dark</span>
                </button>
            </div>
        </div>
    </header>

    <div class="split-container">
        <aside class="sidebar" id="sidebar">
            <div class="controls">
                <div class="control-row">
                    <label for="countrySelect">Country:</label>
                    <select id="countrySelect">
                        <option value="US">United States</option>
                        <option value="IN" selected>India</option>
                        <option value="GB">United Kingdom</option>
                        <option value="CA">Canada</option>
                        <option value="AU">Australia</option>
                        <option value="DE">Germany</option>
                        <option value="BR">Brazil</option>
                        <option value="JP">Japan</option>
                        <option value="KR">South Korea</option>
                        <option value="MX">Mexico</option>
                    </select>
                </div>
                <div class="control-row">
                    <label for="categoryFilter">Category:</label>
                    <select id="categoryFilter">
                        <option value="all">All Categories</option>
                        <option value="10">Music</option>
                        <option value="20">Gaming</option>
                        <option value="22">People & Blogs</option>
                        <option value="23">Comedy</option>
                        <option value="24">Entertainment</option>
                        <option value="25">News & Politics</option>
                        <option value="26">Howto & Style</option>
                        <option value="27">Education</option>
                        <option value="28">Science & Technology</option>
                    </select>
                </div>
                <div class="control-row">
                    <label for="keywordSearch">Search Keyword:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="keywordSearch" placeholder="Enter keyword (e.g., 'music', 'trailer')" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button id="searchBtn" style="padding: 8px 20px; background-color: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer;">Search</button>
                        <button id="clearKeywordBtn" style="padding: 8px 15px; background-color: #999; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">Clear</button>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">0</div>
                    <div class="stat-label">Total Views</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">0</div>
                    <div class="stat-label">Videos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">0%</div>
                    <div class="stat-label">Overall Engagement</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">0</div>
                    <div class="stat-label">Comments</div>
                </div>
            </div>

            <div class="data-insights">
                <h3 class="section-title">
                    <i class="fas fa-chart-pie"></i>
                    Data Insights
                </h3>
                
                <div class="tab-bar">
                    <button class="tab-btn active" data-tab="categories">Categories</button>
                    <button class="tab-btn" data-tab="keywords">Keywords</button>
                    <button class="tab-btn" data-tab="engagement">Engagement</button>
                    <button class="tab-btn" data-tab="timepop">Time vs Pop</button>
                    <button class="tab-btn" data-tab="uploadtimes">Upload Times</button>
                </div>
                
                <div class="chart-tab-container">
                    <div class="chart-tab active" data-tab="categories">
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-tab" data-tab="keywords">
                        <div class="chart-container">
                            <canvas id="keywordChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-tab" data-tab="engagement">
                        <div class="chart-container">
                            <canvas id="engagementChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-tab" data-tab="timepop">
                        <div class="chart-container">
                            <canvas id="timePopularityChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-tab" data-tab="uploadtimes">
                        <div class="chart-container">
                            <canvas id="uploadTimesChart"></canvas>
                        </div>
                        <div id="uploadRecommendations" class="upload-recommendations"></div>
                    </div>
                </div>
            </div>
            <!-- <div class="modal-body">
                <div id="aiLoader" class="ai-loader"></div>
                <div id="suggestionResults">
                    </div>
            </div> -->
        </aside>

        <main class="main-content" id="mainContent">
            <div class="video-section">
                <h3 class="section-title">
                    <i class="fas fa-fire"></i>
                    Trending Videos in India
                </h3>
                
                <div id="loader" class="loader"></div>
                
                <div id="videoGrid" class="video-grid">
                    </div>
                
                <div id="alsoTrendingSection" style="display: none; margin-top: 40px;">
                    <h3 id="alsoTrendingTitle" style="color: var(--heading); margin-bottom: 20px; font-size: 1.5em;"></h3>
                    <div id="alsoTrendingGrid" class="video-grid">
                        </div>
                </div>
            </div>

            <footer class="footer">
                <p>&copy; 2024 YouTube Trending Analyzer. Data from <a href="https://developers.google.com/youtube/v3" target="_blank">YouTube Data API v3</a>.</p>
            </footer>
        </main>
    </div>

    <button class="mobile-toggle" id="mobileToggle">
        <i class="fas fa-chart-pie"></i>
    </button>

    <div id="aiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-lightbulb" style="color: var(--accent);"></i> AI Content Suggestions</h2>
                <span class="modal-close" id="modalCloseBtn">&times;</span>
            </div>
            <div class="modal-body">
                <div id="aiLoader" class="ai-loader"></div>
                <div id="suggestionResults">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const countrySelect = document.getElementById('countrySelect');
        const categoryFilter = document.getElementById('categoryFilter');
        const keywordSearch = document.getElementById('keywordSearch');
        const searchBtn = document.getElementById('searchBtn');
        const clearKeywordBtn = document.getElementById('clearKeywordBtn');
        const videoGrid = document.getElementById('videoGrid');
        const alsoTrendingSection = document.getElementById('alsoTrendingSection');
        const alsoTrendingTitle = document.getElementById('alsoTrendingTitle');
        const alsoTrendingGrid = document.getElementById('alsoTrendingGrid');
        const loader = document.getElementById('loader');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const mobileToggle = document.getElementById('mobileToggle');
        const themeToggleBtn = document.getElementById('themeToggle');
        
        // --- AI Modal DOM Elements ---
        const aiSuggestBtn = document.getElementById('aiSuggestBtn');
        const aiModal = document.getElementById('aiModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const aiLoader = document.getElementById('aiLoader');
        const suggestionResults = document.getElementById('suggestionResults');
        
        // Track current keyword
        let currentKeyword = '';

        // --- Chart Variables ---
        let categoryChart;
        let keywordChart;
        let engagementChart;
        let timePopularityChart;
        let uploadTimesChart;

        // --- YouTube Category Map ---
        const categoryMap = {
            '1': 'Film & Animation',
            '2': 'Autos & Vehicles',
            '10': 'Music',
            '15': 'Pets & Animals',
            '17': 'Sports',
            '18': 'Short Movies',
            '19': 'Travel & Events',
            '20': 'Gaming',
            '21': 'Videoblogging',
            '22': 'People & Blogs',
            '23': 'Comedy',
            '24': 'Entertainment',
            '25': 'News & Politics',
            '26': 'Howto & Style',
            '27': 'Education',
            '28': 'Science & Technology',
            '29': 'Nonprofits & Activism',
            '30': 'Movies',
            '43': 'Shows'
        };

        // --- Event Listeners ---
        countrySelect.addEventListener('change', () => {
            const selectedCountry = countrySelect.value;
            const selectedCountryName = countrySelect.options[countrySelect.selectedIndex].text;
            document.querySelector('.video-section .section-title').innerHTML = 
                `<i class="fas fa-fire"></i> Trending Videos in ${selectedCountryName}`;
            // Clear keyword when country changes
            keywordSearch.value = '';
            currentKeyword = '';
            clearKeywordBtn.style.display = 'none';
            fetchTrendingData(selectedCountry);
        });

        categoryFilter.addEventListener('change', () => {
            const selectedCategory = categoryFilter.value;
            filterVideosByCategory(selectedCategory);
        });

        // --- Keyword Search ---
        function performKeywordSearch() {
            const keyword = keywordSearch.value.trim().toLowerCase();
            if (keyword) {
                currentKeyword = keyword;
                clearKeywordBtn.style.display = 'block';
                fetchTrendingData(countrySelect.value, keyword);
            }
        }

        searchBtn.addEventListener('click', performKeywordSearch);
        keywordSearch.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performKeywordSearch();
            }
        });

        clearKeywordBtn.addEventListener('click', () => {
            keywordSearch.value = '';
            currentKeyword = '';
            clearKeywordBtn.style.display = 'none';
            alsoTrendingSection.style.display = 'none';
            fetchTrendingData(countrySelect.value);
        });

        // --- Mobile Toggle ---
        mobileToggle.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
            mainContent.classList.toggle('full-width');
            
            const icon = mobileToggle.querySelector('i');
            if (sidebar.classList.contains('hidden')) {
                icon.className = 'fas fa-list';
            } else {
                icon.className = 'fas fa-chart-pie';
            }
        });

        // --- Theme Toggle ---
        function updateThemeButtonLabel() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const icon = themeToggleBtn.querySelector('i');
            const text = themeToggleBtn.querySelector('span');
            
            if (isDark) {
                icon.className = 'fas fa-sun';
                text.textContent = 'Light';
            } else {
                icon.className = 'fas fa-moon';
                text.textContent = 'Dark';
            }
        }

        function setTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            localStorage.setItem('theme', theme);
            updateThemeButtonLabel();
            applyThemeToCharts();
        }

        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            setTheme(isDark ? 'light' : 'dark');
        });

        // --- Tab Switching ---
        const tabButtons = document.querySelectorAll('.tab-btn');
        const chartTabs = document.querySelectorAll('.chart-tab');

        function switchTab(tabName) {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            chartTabs.forEach(tab => tab.classList.remove('active'));

            const selectedBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
            const selectedTab = document.querySelector(`.chart-tab[data-tab="${tabName}"]`);
            
            if (selectedBtn) selectedBtn.classList.add('active');
            if (selectedTab) selectedTab.classList.add('active');
        }

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        // --- Data Fetching ---
        async function fetchTrendingData(countryCode, keyword = '') {
            loader.style.display = 'block';
            videoGrid.style.display = 'none';
            alsoTrendingSection.style.display = 'none';

            try {
                let url = `http://127.0.0.1:5000/get_trending_data?country=${countryCode}`;
                if (keyword) {
                    url += `&keyword=${encodeURIComponent(keyword)}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success) {
                    window.currentVideos = data.videos;
                    
                    // If keyword search, show first video in expanded view
                    const showExpanded = keyword && data.videos.length > 0;
                    
                    // Apply category filter if one is selected
                    const selectedCategory = categoryFilter.value;
                    if (selectedCategory !== 'all') {
                        const filtered = data.videos.filter(video => {
                            const videoCategoryId = String(video.category_id || '');
                            return videoCategoryId === String(selectedCategory);
                        });
                        updateVideoGrid(filtered, showExpanded, keyword);
                    } else {
                        updateVideoGrid(data.videos, showExpanded, keyword);
                    }
                    
                    // Handle "Also trending" section
                    if (keyword && data.also_trending && data.also_trending.length > 0) {
                        updateAlsoTrendingGrid(data.also_trending, keyword);
                        alsoTrendingTitle.textContent = `Also trending in "${keyword}"`;
                        alsoTrendingSection.style.display = 'block';
                    } else {
                        alsoTrendingSection.style.display = 'none';
                    }
                    
                    updateCharts(data.category_analysis, data.keyword_analysis, data.upload_vs_popularity, data.upload_times_analysis, data.upload_recommendations);
                    updateStats(data);
                } else {
                    console.error('Error from backend:', data.error);
                    videoGrid.innerHTML = '<p>Could not fetch trending data. Please try again later.</p>';
                }

            } catch (error) {
                console.error('Fetch error:', error);
                videoGrid.innerHTML = `<p>Could not connect to the server. Error: ${error.message}</p>`;
            } finally {
                loader.style.display = 'none';
                videoGrid.style.display = 'grid';
            }
        }

        // --- AI Suggestion Functions ---
        async function fetchAISuggestions() {
            const countryCode = countrySelect.value;
            
            // Show modal and loader
            aiModal.style.display = 'block';
            aiLoader.style.display = 'block';
            suggestionResults.innerHTML = ''; // Clear old results

            try {
                const response = await fetch(`http://127.0.0.1:5000/get_creator_suggestions?country=${countryCode}`);
                
                const data = await response.json();

                if (data.success) {
                    // Check if insights string is empty
                    if (!data.insights || data.insights.trim() === '') {
                        throw new Error('The AI returned an empty response. This might be due to a safety filter or an API issue.');
                    }
                    // Parse and display the suggestions
                    const formattedHtml = parseAndDisplaySuggestions(data.insights);
                    suggestionResults.innerHTML = formattedHtml;
                } else {
                    // This will catch errors from app.py (e.g., {"success": false, "error": "..."})
                    throw new Error(data.error || 'The server reported an unknown error.');
                }

            } catch (error) {
                // This will catch network errors (fetch failed) or the errors thrown above
                console.error('Error fetching AI suggestions:', error);
                
                // Display a much more helpful error message in the modal
                suggestionResults.innerHTML = `
                    <div class="suggestion-error">
                        <strong><i class="fas fa-exclamation-triangle"></i> Oops! Something went wrong.</strong>
                        <p>We couldn't generate AI suggestions. Here's the error message:</p>
                        <p><code>${escapeHtml(error.message)}</code></p>
                        <p style="margin-top: 15px; font-size: 0.9em;">
                            <strong>Common Causes:</strong><br>
                            1. The <code>GEMINI_API_KEY</code> in your <code>.env</code> file is missing or invalid.<br>
                            2. The Google AI API is temporarily down or you've exceeded your quota.<br>
                            3. A network error prevented the server from responding.
                        </p>
                    </div>
                `;
            } finally {
                // Hide loader
                aiLoader.style.display = 'none';
            }
        }

        // --- (MODIFIED) This function now handles leading whitespace ---
        function parseAndDisplaySuggestions(insights) {
            // This makes the parser more robust if the AI adds a title
            const cleanInsights = insights.replace(/^Suggested YouTube Ideas:[\s\n]*/i, '');

            // Split the text block into individual suggestions
            // Assumes suggestions are numbered e.g., "1. ...", "2. ..."
            const suggestionBlocks = cleanInsights.split(/\n(?=\d\.\s)/).filter(s => s.trim());
            let html = '';

            if (suggestionBlocks.length === 0 && cleanInsights.trim()) {
                // Fallback for non-numbered or single-block text
                return `<p>${cleanInsights.replace(/\n/g, '<br>')}</p>`;
            }

            suggestionBlocks.forEach(block => {
                const lines = block.trim().split('\n');
                
                // Ensure title is handled correctly, even if it's the only line
                const title = lines[0] || '';
                
                // --- (FIX) Regex now includes \s* to match leading spaces ---
                const description = lines.find(l => l.match(/\s*-\s*(Cover|Description):/i)) || '';
                const hook = lines.find(l => l.match(/\s*-\s*Hook:/i)) || '';
                const thumbnail = lines.find(l => l.match(/\s*-\s*Thumbnail.*:/i)) || '';

                html += '<div class="suggestion-item">';
                html += `<h3>${escapeHtml(title)}</h3>`;
                
                // --- (FIX) Regex in replace() also includes \s* ---
                if (description) {
                    html += `<p>${escapeHtml(description).replace(/\s*-\s*(Cover|Description):/i, '<strong>$1:</strong>')}</p>`;
                }
                if (hook) {
                    html += `<p>${escapeHtml(hook).replace(/\s*-\s*Hook:/i, '<strong>Hook:</strong>')}</p>`;
                }
                if (thumbnail) {
                    html += `<p>${escapeHtml(thumbnail).replace(/\s*-\s*Thumbnail.*:/i, '<strong>Thumbnail:</strong>')}</p>`;
                }
                html += '</div>';
            });

            return html;
        }
        // --- END MODIFIED SECTION ---

        // --- AI Modal Event Listeners ---
        aiSuggestBtn.addEventListener('click', fetchAISuggestions);
        modalCloseBtn.addEventListener('click', () => {
            aiModal.style.display = 'none';
        });

        // Close modal if user clicks outside of the content
        window.addEventListener('click', (event) => {
            if (event.target == aiModal) {
                aiModal.style.display = 'none';
            }
        });


        // --- Update Functions ---
        function updateVideoGrid(videos, showExpandedFirst = false, keyword = '') {
            videoGrid.innerHTML = '';

            if (videos.length === 0) {
                videoGrid.innerHTML = '<p>No trending videos found for this region.</p>';
                return;
            }

            // If keyword search and showExpandedFirst, show first video in expanded view
            if (showExpandedFirst && keyword && videos.length > 0) {
                const firstVideo = videos[0];
                const sentiment = analyzeSentiment(firstVideo.title, firstVideo.description || '');
                const expandedVideoHtml = createExpandedVideoHtml(firstVideo, sentiment);
                videoGrid.innerHTML += expandedVideoHtml;
                
                // Show remaining videos as cards
                videos.slice(1).forEach(video => {
                    videoGrid.innerHTML += createVideoCard(video);
                });
            } else {
                // Show all videos as cards
                videos.forEach(video => {
                    videoGrid.innerHTML += createVideoCard(video);
                });
            }
        }

        function createVideoCard(video) {
            const videoUrl = `https://www.youtube.com/watch?v=${video.video_id}`;
            const sentiment = analyzeSentiment(video.title, video.description || '');
            
            return `
                <div class="video-card" onclick="window.open('${videoUrl}', '_blank')">
                    <div class="video-thumbnail">
                        <img src="${escapeHtml(video.thumbnail)}" alt="Video thumbnail">
                    </div>
                    <div class="video-info">
                        <h4 class="video-title">${escapeHtml(video.title)}</h4>
                        <div class="video-meta">
                            <div class="video-meta-row">
                                <i class="fas fa-eye"></i>
                                <span>${formatNumber(video.views || 0)} views</span>
                            </div>
                            <div class="video-meta-row">
                                <i class="fas fa-thumbs-up"></i>
                                <span>${formatNumber(video.like_count || 0)}</span>
                            </div>
                            <div class="video-meta-row">
                                <i class="fas fa-comments"></i>
                                <span>${formatNumber(video.comment_count || 0)}</span>
                            </div>
                            <span class="sentiment-badge ${sentiment.class}">${sentiment.label}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function createExpandedVideoHtml(video, sentiment) {
            const videoUrl = `https://www.youtube.com/watch?v=${video.video_id}`;
            
            return `
                <div class="expanded-video" onclick="window.open('${videoUrl}', '_blank')" style="cursor: pointer;">
                    <div class="expanded-video-header">
                        <div class="expanded-video-thumbnail">
                            <img src="${escapeHtml(video.thumbnail)}" alt="${escapeHtml(video.title)}">
                        </div>
                        <div class="expanded-video-info">
                            <h3 class="expanded-video-title">${escapeHtml(video.title)}</h3>
                            <div class="expanded-video-stats">
                                <div class="expanded-video-stat">
                                    <i class="fas fa-eye"></i>
                                    <span>${formatNumber(video.views || 0)} views</span>
                                </div>
                                <div class="expanded-video-stat">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span>${formatNumber(video.like_count || 0)} likes</span>
                                </div>
                                <div class="expanded-video-stat">
                                    <i class="fas fa-comments"></i>
                                    <span>${formatNumber(video.comment_count || 0)} comments</span>
                                </div>
                                <div class="expanded-video-stat">
                                    <span class="sentiment-badge ${sentiment.class}">${sentiment.label}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateAlsoTrendingGrid(videos, keyword) {
            alsoTrendingGrid.innerHTML = '';

            if (videos.length === 0) {
                alsoTrendingGrid.innerHTML = `<p>No additional trending videos found for "${keyword}".</p>`;
                return;
            }

            videos.forEach(video => {
                alsoTrendingGrid.innerHTML += createVideoCard(video);
            });
        }

        function updateStats(data) {
            if (!data || !data.videos) return;

            // Calculate REAL metrics
            const totalViews = data.videos.reduce((sum, video) => sum + parseInt(video.views || 0), 0);
            const totalComments = data.videos.reduce((sum, video) => sum + parseInt(video.comment_count || 0), 0);
            const totalLikes = data.videos.reduce((sum, video) => sum + parseInt(video.like_count || 0), 0);
            
            // Calculate overall engagement rate: (Total Likes + Total Comments) / Total Views * 100
            const overallEngagement = totalViews > 0 
                ? ((totalLikes + totalComments) / totalViews * 100).toFixed(1) 
                : '0.0';

            // Update stats cards with REAL values
            document.querySelector('.stat-value').textContent = formatNumber(totalViews);
            document.querySelectorAll('.stat-value')[1].textContent = data.videos.length;
            document.querySelectorAll('.stat-value')[2].textContent = overallEngagement + '%';
            document.querySelectorAll('.stat-value')[3].textContent = formatNumber(totalComments);
        }

        function filterVideosByCategory(categoryId) {
            if (categoryId === 'all') {
                const showExpanded = currentKeyword && (window.currentVideos || []).length > 0;
                updateVideoGrid(window.currentVideos || [], showExpanded, currentKeyword);
                return;
            }

            // Ensure both sides are strings for proper comparison
            const filteredVideos = (window.currentVideos || []).filter(video => {
                const videoCategoryId = String(video.category_id || '');
                const selectedCategoryId = String(categoryId);
                return videoCategoryId === selectedCategoryId;
            });
            
            if (filteredVideos.length === 0) {
                videoGrid.innerHTML = `<p>No videos found in "${categoryMap[categoryId] || 'selected'}" category.</p>`;
            } else {
                const showExpanded = currentKeyword && filteredVideos.length > 0;
                updateVideoGrid(filteredVideos, showExpanded, currentKeyword);
            }
        }

        // --- Chart Functions ---
        function getCSSVar(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        function getChartPalette() {
            return [
                getCSSVar('--chart1'), getCSSVar('--chart2'), getCSSVar('--chart3'), 
                getCSSVar('--chart4'), getCSSVar('--chart5'), getCSSVar('--chart6'),
                getCSSVar('--chart7'), getCSSVar('--chart8'), getCSSVar('--chart9'), 
                getCSSVar('--chart10')
            ];
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Sentiment Analysis Function
        function analyzeSentiment(title, description) {
            const text = (title + ' ' + description).toLowerCase();
            
            // Positive keywords
            const positiveWords = ['amazing', 'awesome', 'great', 'best', 'love', 'excellent', 'wonderful', 'fantastic', 'perfect', 'brilliant', 'incredible', 'beautiful', 'happy', 'fun', 'enjoy', 'win', 'victory', 'success', 'epic', 'legendary'];
            // Negative keywords
            const negativeWords = ['bad', 'worst', 'hate', 'terrible', 'awful', 'horrible', 'disgusting', 'sad', 'angry', 'fail', 'disaster', 'problem', 'issue', 'scandal', 'controversy', 'crisis', 'danger', 'attack'];
            
            let positiveCount = 0;
            let negativeCount = 0;
            
            positiveWords.forEach(word => {
                if (text.includes(word)) positiveCount++;
            });
            
            negativeWords.forEach(word => {
                if (text.includes(word)) negativeCount++;
            });
            
            if (positiveCount > negativeCount && positiveCount > 0) {
                return { sentiment: 'positive', label: 'Positive', class: 'sentiment-positive' };
            } else if (negativeCount > positiveCount && negativeCount > 0) {
                return { sentiment: 'negative', label: 'Negative', class: 'sentiment-negative' };
            } else {
                return { sentiment: 'neutral', label: 'Neutral', class: 'sentiment-neutral' };
            }
        }

        function updateCharts(categoryData, keywordData, uploadVsPopularityData, uploadTimesData, uploadRecommendations) {
            // Process REAL category data
            const categoryLabels = Object.keys(categoryData).map(id => categoryMap[id] || `Other (${id})`);
            const categoryCounts = Object.values(categoryData);

            // Process REAL keyword data  
            const keywordLabels = keywordData.map(item => item[0]);
            const keywordCounts = keywordData.map(item => item[1]);

            // Update Category Chart with REAL data
            if (categoryChart) {
                categoryChart.data.labels = categoryLabels;
                categoryChart.data.datasets[0].data = categoryCounts;
                categoryChart.update('active');
            } else {
                // Create new chart with REAL data
                const ctx = document.getElementById('categoryChart').getContext('2d');
                categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryCounts,
                            backgroundColor: getChartPalette(),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            animateRotate: true,
                            animateScale: true,
                            duration: 1500,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    font: { size: 10 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} videos (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Update Keyword Chart with REAL data
            if (keywordChart) {
                keywordChart.data.labels = keywordLabels;
                keywordChart.data.datasets[0].data = keywordCounts;
                keywordChart.update('active');
            } else {
                const ctx = document.getElementById('keywordChart').getContext('2d');
                keywordChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: keywordLabels,
                        datasets: [{
                            label: 'Mentions',
                            data: keywordCounts,
                            backgroundColor: getCSSVar('--chart1'),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        animation: {
                            duration: 1500,
                            easing: 'easeInOutQuart',
                            delay: (context) => {
                                return context.dataIndex * 50;
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Mentions: ${context.parsed.x}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Update Engagement Chart with REAL data
            if (window.currentVideos && window.currentVideos.length > 0) {
                const engagementData = window.currentVideos.map(v => ({
                    title: v.title.length > 25 ? v.title.substring(0, 25) + '...' : v.title,
                    rate: parseFloat(v.engagement_rate) || 0
                }));

                const topEngaged = engagementData
                    .sort((a, b) => b.rate - a.rate)
                    .slice(0, 10);

                const engagementLabels = topEngaged.map(v => v.title);
                const engagementRates = topEngaged.map(v => v.rate);

                if (engagementChart) {
                    engagementChart.data.labels = engagementLabels;
                    engagementChart.data.datasets[0].data = engagementRates;
                    engagementChart.update('active');
                } else {
                    const ctx = document.getElementById('engagementChart').getContext('2d');
                    engagementChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: engagementLabels,
                            datasets: [{
                                label: 'Engagement Rate (%)',
                                data: engagementRates,
                                backgroundColor: getCSSVar('--engFill'),
                                borderColor: getCSSVar('--engBorder'),
                                borderWidth: 2,
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 1500,
                                easing: 'easeInOutQuart',
                                delay: (context) => {
                                    return context.dataIndex * 60;
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                title: { 
                                    display: true, 
                                    text: 'Top 10 Videos by Engagement Rate',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    },
                                    padding: {
                                        bottom: 20
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Engagement Rate: ${context.parsed.y.toFixed(2)}%`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { 
                                        display: true, 
                                        text: 'Engagement Rate (%)',
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        }
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                },
                                x: {
                                    ticks: { 
                                        maxRotation: 45, 
                                        minRotation: 45,
                                        font: {
                                            size: 10
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }

            // Update Time vs Popularity Chart with REAL data
            if (uploadVsPopularityData && uploadVsPopularityData.length > 0) {
                if (timePopularityChart) {
                    timePopularityChart.data.datasets[0].data = uploadVsPopularityData;
                    timePopularityChart.update('active');
                } else {
                    const ctx = document.getElementById('timePopularityChart').getContext('2d');
                    timePopularityChart = new Chart(ctx, {
                        type: 'bubble',
                        data: {
                            datasets: [{
                                label: 'Videos',
                                data: uploadVsPopularityData,
                                backgroundColor: getCSSVar('--accent'),
                                borderColor: getCSSVar('--accent'),
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 1500,
                                easing: 'easeInOutQuart',
                                delay: (context) => {
                                    return context.dataIndex * 30;
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            const point = context[0].raw;
                                            const title = point.title || 'Unknown Video';
                                            // Truncate long titles
                                            return title.length > 50 ? title.substring(0, 50) + '...' : title;
                                        },
                                        label: function(context) {
                                            const point = context.raw;
                                            const days = point.x;
                                            const views = point.y.toLocaleString();
                                            const engagement = point.engagement_rate 
                                                ? point.engagement_rate.toFixed(2) 
                                                : ((point.r - 5) / 25 * 100).toFixed(2);
                                            return [
                                                `Days since upload: ${days}`,
                                                `Views: ${views}`,
                                                `Engagement Rate: ${engagement}%`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Days Since Upload',
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        }
                                    },
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value + ' days';
                                        }
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'View Count',
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        }
                                    },
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            if (value >= 1000000) {
                                                return (value / 1000000).toFixed(1) + 'M';
                                            } else if (value >= 1000) {
                                                return (value / 1000).toFixed(1) + 'K';
                                            }
                                            return value;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }

            // Update Upload Times Chart with REAL data
            if (uploadTimesData && uploadTimesData.length > 0) {
                const hourLabels = uploadTimesData.map(item => item.hour_label);
                const averageViews = uploadTimesData.map(item => item.average_views);

                if (uploadTimesChart) {
                    uploadTimesChart.data.labels = hourLabels;
                    uploadTimesChart.data.datasets[0].data = averageViews;
                    uploadTimesChart.update('active');
                } else {
                    const ctx = document.getElementById('uploadTimesChart').getContext('2d');
                    uploadTimesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: hourLabels,
                            datasets: [{
                                label: 'Average Views',
                                data: averageViews,
                                borderColor: getCSSVar('--accent'),
                                backgroundColor: getCSSVar('--accent') + '20',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBackgroundColor: getCSSVar('--accent'),
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 1500,
                                easing: 'easeInOutQuart'
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        color: getCSSVar('--text'),
                                        font: { size: 12, weight: 'bold' },
                                        padding: 15
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Best Upload Times for Maximum Reach',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    },
                                    color: getCSSVar('--text'),
                                    padding: {
                                        bottom: 20
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const views = context.parsed.y.toLocaleString();
                                            const hour = uploadTimesData[context.dataIndex];
                                            return `Average Views: ${views} (${hour.video_count} videos)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Upload Hour (24-hour format)',
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        },
                                        color: getCSSVar('--text')
                                    },
                                    ticks: {
                                        color: getCSSVar('--text'),
                                        maxRotation: 45,
                                        minRotation: 45
                                    },
                                    grid: {
                                        color: getCSSVar('--text') + '20'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Average Views',
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        },
                                        color: getCSSVar('--text')
                                    },
                                    beginAtZero: true,
                                    ticks: {
                                        color: getCSSVar('--text'),
                                        callback: function(value) {
                                            if (value >= 1000000) {
                                                return (value / 1000000).toFixed(1) + 'M';
                                            } else if (value >= 1000) {
                                                return (value / 1000).toFixed(1) + 'K';
                                            }
                                            return value.toLocaleString();
                                        }
                                    },
                                    grid: {
                                        color: getCSSVar('--text') + '20'
                                    }
                                }
                            }
                        }
                    });
                }

                // Display ML Recommendations
                if (uploadRecommendations) {
                    const recContainer = document.getElementById('uploadRecommendations');
                    if (recContainer) {
                        const topHoursHtml = uploadRecommendations.top_hours.map((h, idx) => 
                            `<div class="recommendation-hour">
                                <span class="hour-rank">${idx + 1}</span>
                                <span class="hour-time">${h.hour_label}</span>
                                <span class="hour-views">${formatNumber(h.average_views)} views avg</span>
                            </div>`
                        ).join('');

                        recContainer.innerHTML = `
                            <div class="ml-recommendations">
                                <div class="recommendation-header">
                                    <i class="fas fa-brain"></i>
                                    <h4>ML-Powered Recommendations</h4>
                                </div>
                                <div class="recommendation-main">
                                    <div class="best-time-recommendation">
                                        <div class="recommendation-icon">🕐</div>
                                        <div class="recommendation-content">
                                            <strong>Best Upload Time:</strong>
                                            <span class="best-time">${uploadRecommendations.best_upload_hour_label}</span>
                                            <span class="best-time-stats">Avg: ${formatNumber(uploadRecommendations.best_upload_hour_views)} views</span>
                                        </div>
                                    </div>
                                    <div class="top-hours">
                                        <strong>Top 3 Upload Hours:</strong>
                                        ${topHoursHtml}
                                    </div>
                                    <div class="best-category-recommendation">
                                        <div class="recommendation-icon">📁</div>
                                        <div class="recommendation-content">
                                            <strong>Best Category:</strong>
                                            <span class="best-category">${uploadRecommendations.best_category_name}</span>
                                        </div>
                                    </div>
                                    <div class="recommendation-text">
                                        <p>${uploadRecommendations.recommendation_text}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            }
        }

        function applyThemeToCharts() {
            // Apply theme to existing charts
            if (categoryChart) {
                categoryChart.data.datasets[0].backgroundColor = getChartPalette();
                categoryChart.update();
            }
            if (keywordChart) {
                keywordChart.data.datasets[0].backgroundColor = getCSSVar('--chart1');
                keywordChart.update();
            }
            if (engagementChart) {
                engagementChart.data.datasets[0].backgroundColor = getCSSVar('--engFill');
                engagementChart.data.datasets[0].borderColor = getCSSVar('--engBorder');
                engagementChart.update();
            }
            if (timePopularityChart) {
                const accentColor = getCSSVar('--accent');
                timePopularityChart.data.datasets[0].backgroundColor = accentColor;
                timePopularityChart.data.datasets[0].borderColor = accentColor;
                timePopularityChart.update();
            }
        }

        // --- Initialize ---
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);
        
        // Initial data fetch
        fetchTrendingData('IN');
    </script>
</body>
</html>